@page "/puzzle"
@rendermode @(new InteractiveWebAssemblyRenderMode(false))
@inherits PuzzlePresenter

<PageTitle>Puzzle Glace</PageTitle>

<h3>Puzzle Glace procédural</h3>

<div class="controls">
    <label>Difficulté:</label>
    <select value="@_difficulty" @onchange="OnDifficultyChanged">
        <option value="Easy">Facile</option>
        <option value="Normal">Normal</option>
        <option value="Hard">Difficile</option>
        <option value="Expert">Expert</option>
    </select>

    <label style="margin-left:1rem;">Max largeur:</label>
    <input type="number" min="@Min" max="@CapFor(_difficulty)" @bind="_maxWidth" style="width:5rem;" />

    <label style="margin-left:1rem;">Max hauteur:</label>
    <input type="number" min="@Min" max="@CapFor(_difficulty)" @bind="_maxHeight" style="width:5rem;" />

    <label style="margin-left:1rem;">Seed:</label>
    <input type="text" @bind="_seedInput" style="width:8rem;" placeholder="aléatoire" />

    <button class="btn" style="margin-left:1rem;" @onclick="@Generate">Générer</button>
</div>

@if (_grid is not null)
{
    <div class="legend">
        <span class="cell start"></span> Départ
        <span class="cell end"></span> Arrivée
        <span class="cell path"></span> Chemin garanti
        <span class="cell obstacle"></span> Obstacle
        <span class="cell empty"></span> Glace (vide)
        <span class="cell player"></span> Joueur
    </div>

    <div class="play-controls">
        <button class="btn" @onclick='@(() => SlideButton("U"))'>↑</button>
        <div>
            <button class="btn" @onclick='@(() => SlideButton("L"))'>←</button>
            <button class="btn" @onclick='@(() => SlideButton("D"))'>↓</button>
            <button class="btn" @onclick='@(() => SlideButton("R"))'>→</button>
        </div>
        <small>Clavier: flèches / WASD / ZQSD</small>
    </div>

    <div class="grid-container" style="--size: 480px; --n: @_width; --m: @_height;">
        <div class="grid focusable" tabindex="0" @ref="_gridRef" @onkeydown="OnKeyDown" @onkeydown:preventDefault @onkeydown:stopPropagation>
            @for (int y = 0; y < _height; y++)
            {
                @for (int x = 0; x < _width; x++)
                {
                    string cls = _grid.Cells[x, y].Type switch
                    {
                        CellType.Start => "start",
                        CellType.End => "end",
                        CellType.Path => "path",
                        CellType.Obstacle => "obstacle",
                        _ => "empty"
                    };
                    bool isPlayer = (_player.X == x && _player.Y == y);
                    <div class="cell @cls @(isPlayer ? "player" : string.Empty)" title="(@x,@y)"></div>
                }
            }
        </div>
    </div>

    @if (_won)
    {
        <p class="win">🎉 Bravo ! Vous avez atteint l'arrivée.</p>
    }

    <div class="moves" hidden="@(_grid.MovesForWin.Count == 0)">
        <h4>Suite de mouvements (flèches) pour résoudre:</h4>
        <p>
            @foreach (var m in _grid.MovesForWin)
            {
                @:(@(m switch { SlideQuest.Shared.Enums.Direction.Top => "⬆️", SlideQuest.Shared.Enums.Direction.Bottom => "⬇️", SlideQuest.Shared.Enums.Direction.Left => "⬅️", SlideQuest.Shared.Enums.Direction.Right => "➡️", _ => "" })) 
            }
        </p>
        <p><small>Seed utilisée: @_grid.Seed</small></p>
    </div>

    <div class="terminal">
        <h4>Console de test (SignalR + endpoint)</h4>
        <div class="terminal-log" @ref="_logContainerRef" style="max-height: 160px; overflow:auto; background:#111; color:#0f0; padding:0.5rem; border-radius:4px; font-family:Consolas, monospace;">
            @foreach (var line in _log)
            {
                <div>@line</div>
            }
        </div>
        <div class="terminal-input" style="margin-top:0.5rem; display:flex; gap:0.5rem;">
            <input placeholder="Entrez !up, !down, !left, !right" @bind-value="_commandText" @bind-value:event="oninput" @onkeydown="OnCommandKeyDown" style="flex:1;" />
            <button class="btn" @onclick="SubmitCommandAsync">Envoyer</button>
        </div>
        <small>Astuce: ces commandes appellent POST /direction et déclenchent l'événement SignalR DirectionChanged.</small>
    </div>
}
else
{
    <p>Choisissez une taille et cliquez sur Générer.</p>
}

<script>
    window.sqScrollToBottom = (el) => {
        if (!el) return;
        el.scrollTop = el.scrollHeight;
    };
</script>
